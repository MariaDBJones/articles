---
title: "Toying around with MariaDB : query cache edition"
date: Mon, 30 Jun 2025 13:02:05 GMT
lastUpdated: 2025-06-30T13:02:05.508Z
link: https://medium.com/@arbaudie.it/toying-around-with-mariadb-query-cache-edition-c9c7fa742127?source=rss-c779d007e7fe------2
---

<article><div class="m"><div class="m"><span class="m"></span><section><div><div class="gb gr gs gt gu gv"></div><div class="gw gx gy gz ha"><div class="ac ci"><div class="cp bi gi gj gk gl"><div><h1 class="pw-post-title hb hc hd bg he hf hg hh hi hj hk hl hm hn ho hp hq hr hs ht hu hv hw hx hy hz ia ib ic id bl" data-testid="storyTitle" id="1f29">Toying around with MariaDB : query cache edition</h1><div><div class="speechify-ignore ac cw"><div class="speechify-ignore bi m"><div class="ac ie if ig ih ii ij ik il im in io"><div class="ac r io"><div class="ac ip"><div><div aria-hidden="false" class="bn" role="tooltip"><div class="bf" tabindex="-1"><a data-discover="true" href="/@arbaudie.it?source=post_page---byline--c9c7fa742127---------------------------------------" rel="noopener follow"><div class="m iq ir by is it"><div class="m fr"><img alt="ArBauDie.IT" class="m fk by bz ca de" data-testid="authorPhoto" height="32" loading="lazy" src="https://miro.medium.com/v2/resize:fill:64:64/1*kOs3AqmTfHiFOrSZkt1mqg.png" width="32"/><div class="iu by m bz ca gb o iv gc"></div></div></div></a></div></div></div></div><span class="bg b bh ab bl"><div class="iw ac r"><div class="ac r ix"><div class="ac r"><div><div aria-hidden="false" class="bn" role="tooltip"><div class="bf" tabindex="-1"><span class="bg b bh ab bl"><a class="ah ai aj fo al am an ao ap aq ar as at iy" data-discover="true" data-testid="authorName" href="/@arbaudie.it?source=post_page---byline--c9c7fa742127---------------------------------------" rel="noopener follow">ArBauDie.IT</a></span></div></div></div></div><div class="iz bn"></div></div></div></span></div><div class="ac r ja"><span class="bg b bh ab eb"><div class="ac ag"><span data-testid="storyReadTime">3 min read</span><div aria-hidden="true" class="jb jc m"><span aria-hidden="true" class="m"><span class="bg b bh ab eb">·</span></span></div><span data-testid="storyPublishDate">Jun 30, 2025</span></div></span></div></div><div class="ac cw jd je jf jg jh ji jj jk jl jm jn jo jp jq jr js"><div class="i l x fp fq r"><div class="ki m"><div class="ac r kj kk"><div class="pw-multi-vote-icon fr kl km kn ko"><span data-dd-action-name="Susi presentation tracker clap_footer"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-discover="true" data-testid="headerClapButton" href="/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fvote%2Fp%2Fc9c7fa742127&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40arbaudie.it%2Ftoying-around-with-mariadb-query-cache-edition-c9c7fa742127&amp;user=ArBauDie.IT&amp;userId=c779d007e7fe&amp;source=---header_actions--c9c7fa742127---------------------clap_footer------------------" rel="noopener follow"><div><div aria-hidden="false" class="bn" role="tooltip"><div class="bf" tabindex="-1"><div class="kp aq kq kr ks kt ao ku kv kw ko" role="presentation"><svg aria-label="clap" height="24" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path clip-rule="evenodd" d="M11.37.828 12 3.282l.63-2.454zM13.916 3.953l1.523-2.112-1.184-.39zM8.589 1.84l1.522 2.112-.337-2.501zM18.523 18.92c-.86.86-1.75 1.246-2.62 1.33a6 6 0 0 0 .407-.372c2.388-2.389 2.86-4.951 1.399-7.623l-.912-1.603-.79-1.672c-.26-.56-.194-.98.203-1.288a.7.7 0 0 1 .546-.132c.283.046.546.231.728.5l2.363 4.157c.976 1.624 1.141 4.237-1.324 6.702m-10.999-.438L3.37 14.328a.828.828 0 0 1 .585-1.408.83.83 0 0 1 .585.242l2.158 2.157a.365.365 0 0 0 .516-.516l-2.157-2.158-1.449-1.449a.826.826 0 0 1 1.167-1.17l3.438 3.44a.363.363 0 0 0 .516 0 .364.364 0 0 0 0-.516L5.293 9.513l-.97-.97a.826.826 0 0 1 0-1.166.84.84 0 0 1 1.167 0l.97.968 3.437 3.436a.36.36 0 0 0 .517 0 .366.366 0 0 0 0-.516L6.977 7.83a.82.82 0 0 1-.241-.584.82.82 0 0 1 .824-.826c.219 0 .43.087.584.242l5.787 5.787a.366.366 0 0 0 .587-.415l-1.117-2.363c-.26-.56-.194-.98.204-1.289a.7.7 0 0 1 .546-.132c.283.046.545.232.727.501l2.193 3.86c1.302 2.38.883 4.59-1.277 6.75-1.156 1.156-2.602 1.627-4.19 1.367-1.418-.236-2.866-1.033-4.079-2.246M10.75 5.971l2.12 2.12c-.41.502-.465 1.17-.128 1.89l.22.465-3.523-3.523a.8.8 0 0 1-.097-.368c0-.22.086-.428.241-.584a.847.847 0 0 1 1.167 0m7.355 1.705c-.31-.461-.746-.758-1.23-.837a1.44 1.44 0 0 0-1.11.275c-.312.24-.505.543-.59.881a1.74 1.74 0 0 0-.906-.465 1.47 1.47 0 0 0-.82.106l-2.182-2.182a1.56 1.56 0 0 0-2.2 0 1.54 1.54 0 0 0-.396.701 1.56 1.56 0 0 0-2.21-.01 1.55 1.55 0 0 0-.416.753c-.624-.624-1.649-.624-2.237-.037a1.557 1.557 0 0 0 0 2.2c-.239.1-.501.238-.715.453a1.56 1.56 0 0 0 0 2.2l.516.515a1.556 1.556 0 0 0-.753 2.615L7.01 19c1.32 1.319 2.909 2.189 4.475 2.449q.482.08.971.08c.85 0 1.653-.198 2.393-.579.231.033.46.054.686.054 1.266 0 2.457-.52 3.505-1.567 2.763-2.763 2.552-5.734 1.439-7.586z" fill-rule="evenodd"></path></svg></div></div></div></div></a></span></div><div class="pw-multi-vote-count m kx ky kz la lb lc ld"><p class="bg b ec ab eb"><span class="le">--</span></p></div></div></div><div><div aria-hidden="false" class="bn" role="tooltip"><div class="bf" tabindex="-1"><button aria-label="responses" class="aq kp lf lg ac r fs lh li"><svg class="lj" height="24" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M18.006 16.803c1.533-1.456 2.234-3.325 2.234-5.321C20.24 7.357 16.709 4 12.191 4S4 7.357 4 11.482c0 4.126 3.674 7.482 8.191 7.482.817 0 1.622-.111 2.393-.327.231.2.48.391.744.559 1.06.693 2.203 1.044 3.399 1.044.224-.008.4-.112.486-.287a.49.49 0 0 0-.042-.518c-.495-.67-.845-1.364-1.04-2.057a4 4 0 0 1-.125-.598zm-3.122 1.055-.067-.223-.315.096a8 8 0 0 1-2.311.338c-4.023 0-7.292-2.955-7.292-6.587 0-3.633 3.269-6.588 7.292-6.588 4.014 0 7.112 2.958 7.112 6.593 0 1.794-.608 3.469-2.027 4.72l-.195.168v.255c0 .056 0 .151.016.295.025.231.081.478.154.733.154.558.398 1.117.722 1.659a5.3 5.3 0 0 1-2.165-.845c-.276-.176-.714-.383-.941-.59z"></path></svg></button></div></div></div></div><div class="ac r jt ju jv jw jx jy jz ka kb kc kd ke kf kg kh"><div class="lk l k j e"></div><div class="i l"><div><div aria-hidden="false" class="bn" role="tooltip"><div class="bf" tabindex="-1"><span data-dd-action-name="Susi presentation tracker bookmark_footer"><a class="ah ai aj fo al am an ao ap aq ar as at au av" data-discover="true" data-testid="headerBookmarkButton" href="/m/signin?actionUrl=https%3A%2F%2Fmedium.com%2F_%2Fbookmark%2Fp%2Fc9c7fa742127&amp;operation=register&amp;redirect=https%3A%2F%2Fmedium.com%2F%40arbaudie.it%2Ftoying-around-with-mariadb-query-cache-edition-c9c7fa742127&amp;source=---header_actions--c9c7fa742127---------------------bookmark_footer------------------" rel="noopener follow"><svg aria-label="Add to list bookmark button" class="eb ll" fill="none" height="25" viewbox="0 0 25 25" width="25" xmlns="http://www.w3.org/2000/svg"><path d="M18 2.5a.5.5 0 0 1 1 0V5h2.5a.5.5 0 0 1 0 1H19v2.5a.5.5 0 1 1-1 0V6h-2.5a.5.5 0 0 1 0-1H18zM7 7a1 1 0 0 1 1-1h3.5a.5.5 0 0 0 0-1H8a2 2 0 0 0-2 2v14a.5.5 0 0 0 .805.396L12.5 17l5.695 4.396A.5.5 0 0 0 19 21v-8.5a.5.5 0 0 0-1 0v7.485l-5.195-4.012a.5.5 0 0 0-.61 0L7 19.985z" fill="currentColor"></path></svg></a></span></div></div></div></div><div class="fk lm cu"><div class="m ag"><div class="ac ci"><div class="ln lo lp lq lr ls cp bi"><div class="ac"><div aria-hidden="false" class="bn" role="tooltip"><div><div aria-hidden="false" class="bn" role="tooltip"><div class="bf" tabindex="-1"><button aria-label="Listen" class="ah fs aj fo al am an lt ap aq ar fe lu lv li lw lx ly lz ma t mb mc md me mf mg mh v mi mj mk" data-testid="audioPlayButton"><svg fill="none" height="24" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path clip-rule="evenodd" d="M3 12a9 9 0 1 1 18 0 9 9 0 0 1-18 0m9-10C6.477 2 2 6.477 2 12s4.477 10 10 10 10-4.477 10-10S17.523 2 12 2m3.376 10.416-4.599 3.066a.5.5 0 0 1-.777-.416V8.934a.5.5 0 0 1 .777-.416l4.599 3.066a.5.5 0 0 1 0 .832" fill="currentColor" fill-rule="evenodd"></path></svg><div class="k j e"><p class="bg b bh ab eb">Listen</p></div></button></div></div></div></div></div></div></div></div></div><div aria-describedby="postFooterSocialMenu" aria-hidden="false" aria-labelledby="postFooterSocialMenu" class="bn"><div><div aria-hidden="false" class="bn" role="tooltip"><div class="bf" tabindex="-1"><button aria-controls="postFooterSocialMenu" aria-expanded="false" aria-label="Share Post" class="ah fs aj fo al am an lt ap aq ar fe lu lv li lw lx ly lz ma t mb mc md me mf mg mh v mi mj mk" data-testid="headerSocialShareButton"><svg fill="none" height="24" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path clip-rule="evenodd" d="M15.218 4.931a.4.4 0 0 1-.118.132l.012.006a.45.45 0 0 1-.292.074.5.5 0 0 1-.3-.13l-2.02-2.02v7.07c0 .28-.23.5-.5.5s-.5-.22-.5-.5v-7.04l-2 2a.45.45 0 0 1-.57.04h-.02a.4.4 0 0 1-.16-.3.4.4 0 0 1 .1-.32l2.8-2.8a.5.5 0 0 1 .7 0l2.8 2.79a.42.42 0 0 1 .068.498m-.106.138.008.004v-.01zM16 7.063h1.5a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-11c-1.1 0-2-.9-2-2v-10a2 2 0 0 1 2-2H8a.5.5 0 0 1 .35.15.5.5 0 0 1 .15.35.5.5 0 0 1-.15.35.5.5 0 0 1-.35.15H6.4c-.5 0-.9.4-.9.9v10.2a.9.9 0 0 0 .9.9h11.2c.5 0 .9-.4.9-.9v-10.2c0-.5-.4-.9-.9-.9H16a.5.5 0 0 1 0-1" fill="currentColor" fill-rule="evenodd"></path></svg><div class="k j e"><p class="bg b bh ab eb">Share</p></div></button></div></div></div></div></div></div></div></div></div></div><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="2272"><a class="ah nj" href="https://mariadb.org/documentation/" rel="noopener ugc nofollow" target="_blank">MariaDB</a>’s <a class="ah nj" href="https://mariadb.com/kb/en/query-cache" rel="noopener ugc nofollow" target="_blank">query cache</a> , as explained <a class="ah nj" href="https://mariadb.com/kb/en/query-cache/#how-the-query-cache-works" rel="noopener ugc nofollow" target="_blank">here</a> is a legacy memory-based mechanism which stores the results of SELECT queries to avoid recalculating them when identical queries are executed again. When a SELECT query is run, MariaDB first checks if the result already exists in the cache and returns it directly if found, which significantly improves performance for repetitive queries. The cache is automatically maintained ensuring data consistency in returned results.</p><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="bde9">It is easy to setup with two simple parameters and <a class="ah nj" href="https://mariadb.com/kb/en/server-system-variables/#query_cache_strip_comments" rel="noopener ugc nofollow" target="_blank">an optional third</a> to prevents some typos, untrimmed spaces and comments to get in the way, as follows :</p><pre class="nk nl nm nn no np nq nr bq ns bc bl"><span class="nt nu hd nq b bh nv nw m nx ny" id="9880">query_cache_type = ON<br/>query_cache_size = 28M<br/><br/>query_cache_strip_comments = 1 #optional</span></pre><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="62d7">This feature has been introduced in MySQL 4.0 in 2002 and its main issue is being monolatched thus explaining very poor scalability and locking issues for high write concurrency as mentionned <a class="ah nj" href="https://shatteredsilicon.net/mysql-waiting-for-query-cache-lock/" rel="noopener ugc nofollow" target="_blank">here</a> by the good folks of <a class="ah nj" href="https://www.linkedin.com/company/shatteredsilicon/posts/" rel="noopener ugc nofollow" target="_blank">shattered silicon</a>. This is why it is recomended to disable it by defaut. Beware tho in MariaDB 10.6+ you have to set <strong class="mn he">both</strong> following parameters to disable it :</p><pre class="nk nl nm nn no np nq nr bq ns bc bl"><span class="nt nu hd nq b bh nv nw m nx ny" id="486f">query_cache_type = 0 <br/>query_cache_size = 0</span></pre><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="fc46">It seems not many people know about a third mode of the query cache which is setup this way :</p><pre class="nk nl nm nn no np nq nr bq ns bc bl"><span class="nt nu hd nq b bh nv nw m nx ny" id="2cd5">query_cache_type = ON_DEMAND</span></pre><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="4f35">This setup disables query caching by default but allows you to selectively cache specific queries by adding the <code class="de nz oa ob nq b"><a class="ah nj" href="https://mariadb.com/kb/en/query-cache/#sql_no_cache-and-sql_cache" rel="noopener ugc nofollow" target="_blank">SQL_CACHE</a></code><a class="ah nj" href="https://mariadb.com/kb/en/query-cache/#sql_no_cache-and-sql_cache" rel="noopener ugc nofollow" target="_blank"> hint</a> to individual SELECT statements as follows</p><pre class="nk nl nm nn no np nq nr bq ns bc bl"><span class="nt nu hd nq b bh nv nw m nx ny" id="303f">SELECT SQL_CACHE my_columns FROM mytables WHERE my_other_column = this_value;</span></pre><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="9706">This gives you fine-grained control over which queries get cached rather than caching everything by default. It can be massively usefull when you have a mixed load but can identify a pattern of long TTL datas that are queried quite often. This is typically the case in a CMS or in a product catalog management system where the description pages don’t change much over time.</p><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="3614">Whichever way, using the query cache means monitoring what it does. This can be performed through the observation of the <a class="ah nj" href="https://mariadb.com/kb/en/server-status-variables/#qcache_free_blocks" rel="noopener ugc nofollow" target="_blank">Qcache status variables</a>. The most watched metrics is the hit ratio :</p><pre class="nk nl nm nn no np nq nr bq ns bc bl"><span class="nt nu hd nq b bh nv nw m nx ny" id="994b">Qcache_hits / (Qcache_hits + Qcache_inserts + Qcache_not_cached)</span></pre><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="7aac">and you want it to be over 40%, the more the better. Next comes the insert-to-read ratio</p><pre class="nk nl nm nn no np nq nr bq ns bc bl"><span class="nt nu hd nq b bh nv nw m nx ny" id="9603">Qcache_hits / Qcache_inserts</span></pre><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="c7a3">aiming to monitor the usefulness . Next, is the cache big enough ? Qcache_low_mem_prunes vs Qcache_inserts is telling you just that.</p><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="50f6">Installing the <a class="ah nj" href="https://mariadb.com/kb/en/query-cache-information-plugin/" rel="noopener ugc nofollow" target="_blank">Query Cache Information plugin</a> can also provide with some interesting insights as you can see (and some more) depending on the MariaDB server version :</p><pre class="nk nl nm nn no np nq nr bq ns bc bl"><span class="nt nu hd nq b bh nv nw m nx ny" id="f069">SELECT * FROM information_schema.QUERY_CACHE_INFO;<br/>+------------------+-----------------+---------------------+--------------------+-------------------------+<br/>| STATEMENT_SCHEMA | STATEMENT_TEXT  | RESULT_BLOCKS_COUNT | RESULT_BLOCKS_SIZE | RESULT_BLOCKS_SIZE_USED |<br/>+------------------+-----------------+---------------------+--------------------+-------------------------+<br/>...<br/>| test             | SELECT * FROM a |                   1 |                512 |                     143 |<br/>| test             | select * FROM a |                   1 |                512 |                     143 |<br/>...<br/>+------------------+-----------------+---------------------+--------------------+-------------------------</span></pre><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="45f3">Beware tho, if you run ON_DEMAND mode, the monitoring is much more complicated to monitor since the hit ratio is almost impossible to compute.</p><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="9c19">Of course, in the case of a distributed architecture, like a <a class="ah nj" href="https://mariadb.com/kb/en/getting-started-with-mariadb-galera-cluster/" rel="noopener ugc nofollow" target="_blank">Galera cluster</a> or an <a class="ah nj" href="https://mariadb.com/kb/en/standard-replication/" rel="noopener ugc nofollow" target="_blank">asynchronous master-replica replication</a> topology , each server will have to manage its own Query cache, reducing the overall efficiency. If you are using a proxy such as <a class="ah nj" href="https://mariadb.com/kb/en/mariadb-maxscale-2106-maxscale-2106-about-mariadb-maxscale/" rel="noopener ugc nofollow" target="_blank">Maxscale</a> for managing the readwritesplitting, you can add to the service a <a class="ah nj" href="https://mariadb.com/kb/en/mariadb-maxscale-2106-cache/" rel="noopener ugc nofollow" target="_blank">cache filter</a> that will provide caching for the whole topology. Now the question is : when is which approach worth it ?</p><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="ed54">Obviously, if you dont use Maxscale, then the Query cache stays a very interesting piece of software.</p><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="5d94">Funnily enough, a few days after finishing redacting this story i attended a roadshow during which one of the presenters stated that they cannot disable the query cache without breaking their app. A clear sign that despite being severly outdated and desperatly needing some love, it is still an interesting piece of software.</p><p class="pw-post-body-paragraph ml mm hd mn b mo mp mq mr ms mt mu mv mw mx my mz na nb nc nd ne nf ng nh ni gw bl" id="0d58">And there is more brewing on the topic !!!</p></div></div></div></div></section></div></div></article>
